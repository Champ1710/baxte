name: Build and Push bn-tax-aggregator-service

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.2.3)'
        required: true

permissions:
  contents: read
  packages: write

env:
  GHCR_USER: ${{ github.actor }}
  GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
  REGISTRY: ghcr.io
  IMAGE_LATEST_TAG: latest

jobs:
  build-and-push:
    runs-on: self-hosted
    outputs:
      jar_path: ${{ steps.jar.outputs.jar_path }}
      jar_name: ${{ steps.jar.outputs.jar_name }}
      image_ref: ${{ steps.tags.outputs.image_ref }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: temurin

      - name: Configure Maven for GitHub Packages
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<EOF
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>github</id>
                <username>${{ github.actor }}</username>
                <password>${{ secrets.GITHUB_TOKEN }}</password>
              </server>
            </servers>
          </settings>
          EOF

      - name: Build JAR
        run: /opt/apache-maven-3.9.6/bin/mvn clean package -DskipTests

      - name: Locate Built JAR
        id: jar
        run: |
          JAR_PATH=$(find target -name "bn-tax-aggregator-service-*.jar" | grep -v "original" | head -n 1)
          JAR_NAME=$(basename "$JAR_PATH")
          echo "jar_path=$JAR_PATH" >> $GITHUB_OUTPUT
          echo "jar_name=$JAR_NAME" >> $GITHUB_OUTPUT

      - name: Define Image Tags
        id: tags
        run: |
          VERSION=${{ github.event.inputs.version }}
          REPO=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_VERSIONED=${REGISTRY}/$REPO:$VERSION
          IMAGE_LATEST=${REGISTRY}/$REPO:$IMAGE_LATEST_TAG
          IMAGE_SHA=${REGISTRY}/$REPO:${GITHUB_SHA}
          echo "IMAGE_VERSIONED=$IMAGE_VERSIONED" >> $GITHUB_ENV
          echo "IMAGE_LATEST=$IMAGE_LATEST" >> $GITHUB_ENV
          echo "IMAGE_SHA=$IMAGE_SHA" >> $GITHUB_ENV
          echo "image_ref=$IMAGE_VERSIONED" >> $GITHUB_OUTPUT

      - name: Podman Login
        run: echo "$GHCR_TOKEN" | podman login $REGISTRY -u "$GHCR_USER" --password-stdin

      - name: Build Podman Image
        run: |
          podman build --no-cache --build-arg JAR_PATH="${{ steps.jar.outputs.jar_path }}" \
            -t "$IMAGE_SHA" -t "$IMAGE_LATEST" -t "$IMAGE_VERSIONED" .
          echo "Built image: $IMAGE_VERSIONED"

      - name: Push Podman Images
        run: |
          for TAG in "$IMAGE_SHA" "$IMAGE_LATEST" "$IMAGE_VERSIONED"; do
            podman push "$TAG"
          done
