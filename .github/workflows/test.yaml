name: Deploy bn-tax-aggregator-service to QA

on:
  workflow_run:
    workflows: ["Build and Push bn-tax-aggregator-service"]
    types:
      - completed

permissions:
  contents: read
  packages: read 

env:
  GHCR_USER: ${{ github.actor }}
  GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
  SPRING_PROFILES_ACTIVE: qa3
  REGISTRY: ghcr.io

jobs:
  deploy:
    runs-on: self-hosted
    environment: qa
    strategy:
      matrix:
        host: [10.239.80.64,10.239.80.65]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        run: |
          if [ $? -ne 0 ]; then
            echo "Checkout failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Set Deployment Image
        run: |
          echo "IMAGE_REF=${{ github.event.workflow_run.outputs.image_ref }}" >> $GITHUB_ENV
          if [ $? -ne 0 ]; then
            echo "Setting IMAGE_REF failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          if [ $? -ne 0 ]; then
            echo "Failed to create .ssh directory" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "$DEPLOY_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa
          ssh-keyscan -H ${{ matrix.host }} >> ~/.ssh/known_hosts

      - name: Update .env-qa3 with image
        run: |
          sed -i "s|^IMAGE=.*|IMAGE=${IMAGE_REF}|" .env-qa3
          if [ $? -ne 0 ]; then
            echo "Failed to update IMAGE in .env-qa3" >> $GITHUB_OUTPUT
            exit 1
          fi
          sed -i "s|^SPRING_PROFILES_ACTIVE=.*|SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE}|" .env-qa3
          if [ $? -ne 0 ]; then
            echo "Failed to update SPRING_PROFILES_ACTIVE in .env-qa3" >> $GITHUB_OUTPUT
            exit 1
          fi
          cat .env-qa3

      - name: Copy Deployment Files
        run: |
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            compose.yaml .env-qa3 restart.sh diagnose.sh \
            ecom@${{ matrix.host }}:/opt/app/vfill/microservices/bn-tax-aggregator-service
          if [ $? -ne 0 ]; then
            echo "SCP failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Deploy on QA Host
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ecom@${{ matrix.host }} bash -c "'
            cd /opt/app/vfill/microservices/bn-tax-aggregator-service
            chmod +x restart.sh
            ./restart.sh --force-recreate
            if [ $? -ne 0 ]; then
              echo "restart.sh failed" >> $GITHUB_OUTPUT
              exit 1
            fi
            chmod +x diagnose.sh
            ./diagnose.sh
            if [ $? -ne 0 ]; then
              echo "diagnose.sh failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          '"
