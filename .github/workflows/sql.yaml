name: SQL Deployment Pipeline

on:
  push:
    branches:
      - UAT
    paths:
      - 'Databases/**'
      - '!Databases/**/dbo/Datascripts/**'

jobs:
  deploy-to-test:
    name: Deploy Changed SQL Scripts to TEST
    runs-on: windows-latest

    env:
      testServer: sql1                # ✅ Your SQL Server name here
      sqlUser: ${{ secrets.SQL_USER }}
      sqlPassword: ${{ secrets.SQL_PASSWORD }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find changed SQL files
        id: detect
        shell: pwsh
        run: |
          git fetch origin UAT
          $changed = git diff --name-only HEAD^ HEAD | Where-Object { $_ -match '^Databases/.+\.sql$' }
          if ($changed) {
            $changed | ForEach-Object { Write-Host "Detected change: $_" }
            $changed -join "," | Out-File changed.txt
          } else {
            Write-Host "No relevant SQL changes."
            exit 0
          }

      - name: Deploy changed SQL files
        if: success()
        shell: pwsh
        run: |
          $files = Get-Content changed.txt -Raw -ErrorAction SilentlyContinue -split ","
          foreach ($file in $files) {
            if (-not (Test-Path $file)) { continue }
            Write-Host "Executing: $file"
            sqlcmd -S $env:testServer -U $env:sqlUser -P $env:sqlPassword -b -C -i $file
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Execution failed for $file"
              exit 1
            }
          }
          Write-Host "✅ SQL deployment completed successfully."
