name: SQL Deployment Pipeline

on:
  push:
    branches:
      - UAT
    paths:
      - 'Databases/**/dbo/Stored Procedures/**/*.sql'
  workflow_dispatch:  # allows manual run from GitHub Actions tab

jobs:
  deploy-sql:
    runs-on: windows-latest

    env:
      sqlServer: "sql1"             # ðŸ”¹ your SQL Server name
      sqlUser: ${{ secrets.SQL_USER }}       # ðŸ”¹ set this in GitHub Secrets
      sqlPassword: ${{ secrets.SQL_PASSWORD }} # ðŸ”¹ set this in GitHub Secrets
      databaseName: "CLA_Portal"    # ðŸ”¹ target database

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find changed SQL files
        id: changes
        run: |
          git fetch origin UAT
          $changed = git diff --name-only HEAD~1 HEAD | Where-Object { $_ -like "Databases/*/dbo/Stored Procedures/*.sql" }
          if ($changed) {
            Write-Host "Changed SQL files:"
            $changed | ForEach-Object { Write-Host $_ }
            echo "files=$($changed -join ',')" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "No SQL file changes found."
            echo "files=" >> $env:GITHUB_OUTPUT
          }

      - name: Run SQL files on server
        if: steps.changes.outputs.files != ''
        run: |
          $files = "${{ steps.changes.outputs.files }}".Split(',')
          foreach ($file in $files) {
            Write-Host "----------------------------------------"
            Write-Host "Executing SQL script: $file"
            sqlcmd -S $env:sqlServer -U $env:sqlUser -P $env:sqlPassword -d $env:databaseName -b -C -i $file
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Execution failed for $file"
              exit 1
            }
          }
          Write-Host "âœ… All SQL scripts executed successfully."
