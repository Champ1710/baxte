name: Build and Push bn-tax-aggregator-service

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version to build and push (e.g., 1.2.3)'
        required: true

permissions:
  contents: read
  packages: write

env:
  GHCR_USER: ${{ github.actor }}
  GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  REGISTRY: ghcr.io
  IMAGE_LATEST_TAG: latest

jobs:
  build-and-push:
    runs-on: self-hosted
    outputs:
      jar_path: ${{ steps.jar.outputs.jar_path }}
      jar_name: ${{ steps.jar.outputs.jar_name }}
      image_ref: ${{ steps.tags.outputs.image_ref }}

    steps:
      - name: Checkout Latest Code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0
          clean: true

      - name: Show Commit Info
        run: git log -1 --oneline

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Configure Maven
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<EOF
          <settings>
            <servers>
              <server>
                <id>github</id>
                <username>${{ github.actor }}</username>
                <password>${{ secrets.GITHUB_TOKEN }}</password>
              </server>
            </servers>
          </settings>
          EOF

      - name: Build JAR
        run: /opt/apache-maven-3.9.6/bin/mvn clean package -DskipTests

      - name: Locate Built JAR
        id: jar
        run: |
          JAR_PATH=$(find target -name "bn-tax-aggregator-service-*.jar" | grep -v "original" | head -n 1)
          JAR_NAME=$(basename "$JAR_PATH")
          echo "jar_path=$JAR_PATH" >> $GITHUB_OUTPUT
          echo "jar_name=$JAR_NAME" >> $GITHUB_OUTPUT

      - name: Set Image Tag from Manual Input
        id: set_version
        run: |
          IMAGE_TAG=${{ github.event.inputs.version }}
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "version=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Define Image Tags
        id: tags
        run: |
          REPO=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_VERSIONED=${REGISTRY}/$REPO:$IMAGE_TAG
          IMAGE_LATEST=${REGISTRY}/$REPO:${IMAGE_LATEST_TAG}
          IMAGE_SHA=${REGISTRY}/$REPO:${GITHUB_SHA}
          echo "IMAGE_VERSIONED=$IMAGE_VERSIONED" >> $GITHUB_ENV
          echo "IMAGE_LATEST=$IMAGE_LATEST" >> $GITHUB_ENV
          echo "IMAGE_SHA=$IMAGE_SHA" >> $GITHUB_ENV
          echo "image_ref=$IMAGE_VERSIONED" >> $GITHUB_OUTPUT

      - name: Podman Login
        run: echo "$GHCR_TOKEN" | podman login $REGISTRY -u "$GHCR_USER" --password-stdin

      - name: Build Podman Image (no cache)
        run: |
          podman build --no-cache \
            --build-arg JAR_PATH="${{ steps.jar.outputs.jar_path }}" \
            -t "$IMAGE_SHA" \
            -t "$IMAGE_LATEST" \
            -t "$IMAGE_VERSIONED" .

      - name: Push Podman Images
        run: |
          for TAG in "$IMAGE_SHA" "$IMAGE_LATEST" "$IMAGE_VERSIONED"; do
            podman push "$TAG"
            if [ $? -ne 0 ]; then
                echo "Failed to push $TAG"
                exit 1
            fi
          done
