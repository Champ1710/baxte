name: Deploy bn-tax-aggregator-service to QA

on:
  workflow_dispatch:
    inputs:
      approved:
        description: 'Set to yes to approve QA deployment'
        required: true
        default: 'no'

permissions: 
  contents: read
  packages: read

env:
  GHCR_USER: ${{ github.actor }}
  GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
  SPRING_PROFILES_ACTIVE: qa3
  REGISTRY: ghcr.io

jobs:
  check-approval:
    runs-on: ubuntu-latest
    outputs:
      approved: ${{ steps.check.outputs.approved }}
    steps:
      - name: Check QA Approval
        id: check
        run: |
          if [ "${{ github.event.inputs.approved }}" != "yes" ]; then
            echo "QA deployment not approved. Exiting."
            exit 1
          fi
          echo "approved=yes" >> $GITHUB_OUTPUT

  deploy:
    needs: check-approval
    runs-on: self-hosted
    strategy:
      matrix:
        host: [10.239.80.64,10.239.80.65]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa
          ssh-keyscan -H ${{ matrix.host }} >> ~/.ssh/known_hosts

      - name: Update .env-qa3
        run: |
          sed -i "s|^SPRING_PROFILES_ACTIVE=.*|SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE}|" .env-qa3
          cat .env-qa3

      - name: Copy Deployment Files
        run: |
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            compose.yaml .env-qa3 restart.sh diagnose.sh \
            ecom@${{ matrix.host }}:/opt/app/vfill/microservices/bn-tax-aggregator-service

      - name: Deploy on QA Host
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ecom@${{ matrix.host }} bash -c "'
            cd /opt/app/vfill/microservices/bn-tax-aggregator-service
            chmod +x restart.sh
            ./restart.sh --force-recreate
            chmod +x diagnose.sh
            ./diagnose.sh
          '"
