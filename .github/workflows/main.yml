name: Deployment Pipeline

on:
  push:
    branches:
      - TEST   # trigger only on TEST branch changes

jobs:
  promote-to-dev:
    name: Promote TEST → DEV
    runs-on: self-hosted
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history for merging

      - name: Setup Git
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

      - name: Merge TEST into DEV
        run: |
          git checkout DEV
          git merge origin/TEST --no-ff -m "Auto-promote TEST → DEV"
          git push origin DEV

  deploy-dev:
    name: Deploy to DEV Server
    needs: promote-to-dev
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
        with:
          ref: DEV

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 20.41.12.28 >> ~/.ssh/known_hosts

      - name: Sync to DEV Server
        run: |
          rsync -avz ./ ${{ secrets.DEV_USER }}@20.41.12.28:/path/to/deploy

  promote-to-qa:
    name: Promote DEV → QA
    needs: deploy-dev
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

      - name: Merge DEV into QA
        run: |
          git checkout QA
          git merge origin/DEV --no-ff -m "Auto-promote DEV → QA"
          git push origin QA

  deploy-qa:
    name: Deploy to QA Server
    needs: promote-to-qa
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
        with:
          ref: QA

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 20.57.59.31 >> ~/.ssh/known_hosts

      - name: Sync to QA Server
        run: |
          rsync -avz ./ ${{ secrets.QA_USER }}@20.57.59.31:/path/to/deploy

  promote-to-prod:
    name: Promote QA → PROD
    needs: deploy-qa
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

      - name: Merge QA into PROD
        run: |
          git checkout PROD
          git merge origin/QA --no-ff -m "Auto-promote QA → PROD"
          git push origin PROD

  deploy-prod:
    name: Deploy to PROD Server
    needs: promote-to-prod
    runs-on: self-hosted
    environment: production   # restrict so only NOC can approve
    steps:
      - uses: actions/checkout@v4
        with:
          ref: PROD

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H <PROD_IP> >> ~/.ssh/known_hosts

      - name: Sync to PROD Server
        run: |
          rsync -avz ./ ${{ secrets.PROD_USER }}@<PROD_IP>:/path/to/deploy
