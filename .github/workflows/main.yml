name: Multi-Stage Promotion

on:
  push:
    branches:
      - test
      - dev
      - qa
      - prod
  workflow_dispatch:

jobs:
  promote:
    runs-on: self-hosted   # ðŸ‘ˆ your runner
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      # Step 1: Configure SSH
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/airflow_deploy_key
          chmod 600 ~/.ssh/airflow_deploy_key
          ssh-keyscan -H 20.1.156.227 >> ~/.ssh/known_hosts
          ssh-keyscan -H 20.41.12.28 >> ~/.ssh/known_hosts
          ssh-keyscan -H 20.57.59.31 >> ~/.ssh/known_hosts

      # Step 2: TEST â†’ DEV branch
      - name: Promote test â†’ dev
        run: |
          git fetch origin
          git checkout dev || git checkout -b dev
          git merge origin/test --no-edit || echo "No changes to merge"
          git push origin dev

      # Step 3: Sync DEV branch â†’ DEV server
      - name: Sync DEV to server
        run: |
          sftp -i ~/.ssh/airflow_deploy_key -o StrictHostKeyChecking=no airflow@20.1.156.227 <<EOF
          mkdir /app || true
          put -r * /app/
          bye
          EOF

          ssh -i ~/.ssh/airflow_deploy_key -o StrictHostKeyChecking=no airflow@20.1.156.227 "ls -l /app"

      # Step 4: DEV â†’ QA branch
      - name: Promote dev â†’ qa
        run: |
          git checkout qa || git checkout -b qa
          git merge origin/dev --no-edit || echo "No changes to merge"
          git push origin qa

      # Step 5: Sync QA branch â†’ QA server
      - name: Sync QA to server
        run: |
          sftp -i ~/.ssh/airflow_deploy_key -o StrictHostKeyChecking=no airflow@20.41.12.28 <<EOF
          mkdir /app || true
          put -r * /app/
          bye
          EOF
          ssh -i ~/.ssh/airflow_deploy_key -o StrictHostKeyChecking=no airflow@20.41.12.28 "ls -l /app"

  sync-prod:
    runs-on: self-hosted   # ðŸ‘ˆ same runner
    needs: promote
    environment: production   # requires manual approval from NOC
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/airflow_deploy_key
          chmod 600 ~/.ssh/airflow_deploy_key
          ssh-keyscan -H 20.57.59.31 >> ~/.ssh/known_hosts

      # Step 6: QA â†’ PROD branch
      - name: Promote qa â†’ prod
        run: |
          git fetch origin
          git checkout prod || git checkout -b prod
          git merge origin/qa --no-edit || echo "No changes to merge"
          git push origin prod

      # Step 7: Notify NOC
      - name: Notify NOC
        run: echo "QA â†’ PROD promotion approved. Files ready for sync."

      # Step 8: Sync PROD â†’ PROD server
      - name: Sync PROD to server
        run: |
          sftp -i ~/.ssh/airflow_deploy_key -o StrictHostKeyChecking=no airflow@20.57.59.31 <<EOF
          mkdir /app || true
          put -r * /app/
          bye
          EOF
          ssh -i ~/.ssh/airflow_deploy_key -o StrictHostKeyChecking=no airflow@20.57.59.31 "ls -l /app"
