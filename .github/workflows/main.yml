name: Branch Promotion Pipeline

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to promote/deploy"
        required: true
        default: "test"
        type: choice
        options:
          - test
          - dev
          - qa
          - prod

permissions:
  contents: write

jobs:
  # ---------------------- TEST â†’ DEV ----------------------
  promote-dev:
    if: ${{ github.event.inputs.branch == 'test' }}
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Force overwrite dev with test
        run: |
          git config user.name "ci-bot"
          git config user.email "ci-bot@example.com"
          git fetch origin
          git checkout dev || git checkout -b dev origin/dev
          git reset --hard origin/test
          git push origin dev --force

  deploy-dev:
    if: ${{ github.event.inputs.branch == 'test' }}
    runs-on: self-hosted
    needs: promote-dev
    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4

      - name: Upload files to Dev via SFTP
        run: |
          ssh -i /home/azure/.ssh/airflow_deploy_key -o StrictHostKeyChecking=no airflow@20.1.156.227 "mkdir -p /app"
          sftp -i /home/azure/.ssh/airflow_deploy_key -o StrictHostKeyChecking=no airflow@20.1.156.227 <<EOF
          put -r * /app/
          bye
          EOF

  # ---------------------- DEV â†’ QA ----------------------
  promote-qa:
    if: ${{ github.event.inputs.branch == 'dev' }}
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Force overwrite qa with dev
        run: |
          git config user.name "ci-bot"
          git config user.email "ci-bot@example.com"
          git fetch origin
          git checkout qa || git checkout -b qa origin/qa
          git reset --hard origin/dev
          git push origin qa --force

  deploy-qa:
    if: ${{ github.event.inputs.branch == 'dev' }}
    runs-on: self-hosted
    needs: promote-qa
    steps:
      - name: Checkout qa branch
        uses: actions/checkout@v4

      - name: Upload files to QA via SFTP
        run: |
          ssh -i /home/azure/.ssh/airflow_deploy_key -o StrictHostKeyChecking=no airflow@20.41.12.28 "mkdir -p /app"
          sftp -i /home/azure/.ssh/airflow_deploy_key -o StrictHostKeyChecking=no airflow@20.41.12.28 <<EOF
          put -r * /app/
          bye
          EOF

  # ---------------------- QA â†’ PROD ----------------------
  promote-prod:
    if: ${{ github.event.inputs.branch == 'qa' }}
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Force overwrite prod with qa
        run: |
          git config user.name "ci-bot"
          git config user.email "ci-bot@example.com"
          git fetch origin
          git checkout prod || git checkout -b prod origin/prod
          git reset --hard origin/qa
          git push origin prod --force

  notify-noc:
    if: ${{ github.event.inputs.branch == 'qa' }}
    runs-on: self-hosted
    needs: promote-prod
    steps:
      - name: Notify NOC Team
        run: |
          echo "âœ… NOC Team: Prod branch is ready for deployment on 20.57.59.31"
          # Send Slack/Teams/Email here if needed

  deploy-prod:
    if: ${{ github.event.inputs.branch == 'qa' }}
    runs-on: self-hosted
    needs: notify-noc
    environment: production   # ðŸ‘ˆ requires manual approval
    steps:
      - name: Checkout prod branch
        uses: actions/checkout@v4

      - name: Upload files to Prod via SFTP
        run: |
          ssh -i /home/azure/.ssh/airflow_deploy_key -o StrictHostKeyChecking=no airflow@20.57.59.31 "mkdir -p /app"
          sftp -i /home/azure/.ssh/airflow_deploy_key -o StrictHostKeyChecking=no airflow@20.57.59.31 <<EOF
          put -r * /app/
          bye
          EOF
