name: Branch Promotion & Deployment

on:
  push:
    branches:
      - test
      - dev
      - qa
      - prod
permissions:
  contents: write

jobs:
  promote-dev:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Promote test → dev
        run: |
          git config user.name "ci-bot"
          git config user.email "ci-bot@example.com"
          git fetch origin
          if git show-ref --verify --quiet refs/heads/dev; then
            git checkout dev
          else
            git checkout -b dev
          fi
          git merge --no-ff origin/test -m "Promote test → dev" || true
          git push origin dev

  deploy-dev:
    runs-on: self-hosted
    needs: promote-dev
    steps:
      - uses: actions/checkout@v4
        with:
          ref: dev

      - name: Sync to DEV Server
        run: |
          rsync -avz -e "ssh -i /home/azure/.ssh/airflow_deploy_key" ./ airflow@20.1.156.227:/app/
          ssh -i /home/azure/.ssh/airflow_deploy_key airflow@20.1.156.227 "ls -l /app/"

  promote-qa:
    runs-on: self-hosted
    needs: deploy-dev
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Promote dev → qa
        run: |
          git config user.name "ci-bot"
          git config user.email "ci-bot@example.com"
          git fetch origin
          if git show-ref --verify --quiet refs/heads/qa; then
            git checkout qa
          else
            git checkout -b qa
          fi
          git merge --no-ff origin/dev -m "Promote dev → qa" || true
          git push origin qa

  deploy-qa:
    runs-on: self-hosted
    needs: promote-qa
    steps:
      - uses: actions/checkout@v4
        with:
          ref: qa

      - name: Sync to QA Server
        run: |
          rsync -avz -e "ssh -i /home/azure/.ssh/airflow_deploy_key" ./ airflow@20.41.12.28:/app/
          ssh -i /home/azure/.ssh/airflow_deploy_key airflow@20.41.12.28 "ls -l /app/"

  promote-prod:
    runs-on: self-hosted
    needs: deploy-qa
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Promote qa → prod
        run: |
          git config user.name "ci-bot"
          git config user.email "ci-bot@example.com"
          git fetch origin
          if git show-ref --verify --quiet refs/heads/prod; then
            git checkout prod
          else
            git checkout -b prod
          fi
          git merge --no-ff origin/qa -m "Promote qa → prod" || true
          git push origin prod

  notify-noc:
    runs-on: self-hosted
    needs: promote-prod
    steps:
      - name: Notify NOC
        run: echo "NOC Team notified:PROD promotion completed."

  deploy-prod:
    runs-on: self-hosted
    needs: notify-noc
    steps:
      - uses: actions/checkout@v4
        with:
          ref: prod

      - name: Sync to PROD Server
        run: |
          rsync -avz -e "ssh -i /home/azure/.ssh/airflow_deploy_key" ./ airflow@20.57.59.31:/app/
          ssh -i /home/azure/.ssh/airflow_deploy_key airflow@20.57.59.31 "ls -l /app/"
