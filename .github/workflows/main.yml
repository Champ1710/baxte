name: Branch Promotion Pipeline

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to promote/deploy"
        required: true
        default: "test"
        type: choice
        options: 
          - test
          - dev
          - qa
          - prod

jobs:
  promote-dev:
    if: ${{ github.event.inputs.branch == 'test' }}
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Force overwrite dev with test
        run: |
          git config user.name "ci-bot"
          git config user.email "ci-bot@example.com"
          git fetch origin
          git checkout dev || git checkout -b dev origin/dev
          git reset --hard origin/test
          git push origin dev --force

  deploy-dev:
    if: ${{ github.event.inputs.branch == 'dev' }}
    runs-on: self-hosted
    needs: promote-dev
    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4

      - name: Sync to Dev Server (20.1.156.227)
        run: |
          rsync -avz -e "ssh -i /home/azure/.ssh/airflow_deploy_key" ./ airflow@20.1.156.227:/app/
          ssh -i /home/azure/.ssh/airflow_deploy_key airflow@20.1.156.227 "ls -l /app/"

  promote-qa:
    if: ${{ github.event.inputs.branch == 'dev' }}
    runs-on: self-hosted
    needs: deploy-dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Force overwrite qa with dev
        run: |
          git config user.name "ci-bot"
          git config user.email "ci-bot@example.com"
          git fetch origin
          git checkout qa || git checkout -b qa origin/qa
          git reset --hard origin/dev
          git push origin qa --force

  deploy-qa:
    if: ${{ github.event.inputs.branch == 'qa' }}
    runs-on: self-hosted
    needs: promote-qa
    steps:
      - name: Checkout qa branch
        uses: actions/checkout@v4

      - name: Sync to QA Server (20.41.12.28)
        run: |
          rsync -avz -e "ssh -i /home/azure/.ssh/airflow_deploy_key" ./ airflow@20.41.12.28:/app/
          ssh -i /home/azure/.ssh/airflow_deploy_key airflow@20.41.12.28 "ls -l /app/"

  promote-prod:
    if: ${{ github.event.inputs.branch == 'qa' }}
    runs-on: self-hosted
    needs: deploy-qa
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Force overwrite prod with qa
        run: |
          git config user.name "ci-bot"
          git config user.email "ci-bot@example.com"
          git fetch origin
          git checkout prod || git checkout -b prod origin/prod
          git reset --hard origin/qa
          git push origin prod --force

  notify-noc:
    if: ${{ github.event.inputs.branch == 'prod' }}
    runs-on: self-hosted
    needs: promote-prod
    steps:
      - name: Notify NOC Team
        run: |
          echo "âœ… NOC Team: Prod branch is ready for deployment on 20.57.59.31"
          # Send Slack/Teams/Email here if needed

  deploy-prod:
    if: ${{ github.event.inputs.branch == 'prod' }}
    runs-on: self-hosted
    needs: notify-noc
    environment: production   # ðŸ‘ˆ requires manual approval (NOC step)
    steps:
      - name: Checkout prod branch
        uses: actions/checkout@v4

      - name: Sync to Prod Server (20.57.59.31)
        run: |
          rsync -avz -e "ssh -i /home/azure/.ssh/airflow_deploy_key" ./ airflow@20.57.59.31:/app/
          ssh -i /home/azure/.ssh/airflow_deploy_key airflow@20.57.59.31 "ls -l /app/"
